local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local ghostOn = false
local originalCFrame = nil

-- GUI setup
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "GhostToggle"
gui.ResetOnSpawn = false

local menuFrame = Instance.new("Frame")
menuFrame.Size = UDim2.new(0, 160, 0, 60)
menuFrame.Position = UDim2.new(0.5, -80, 0.5, -30)
menuFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
menuFrame.BorderSizePixel = 0
menuFrame.Active = true
menuFrame.Draggable = true
menuFrame.Parent = gui

-- Kéo bằng cảm ứng
local dragging, dragInput, dragStart, startPos = false, nil, nil, nil

menuFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = menuFrame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)

menuFrame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement then
		dragInput = input
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		local delta = input.Position - dragStart
		menuFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

-- Nút bật/tắt ghost
local button = Instance.new("TextButton")
button.Size = UDim2.new(1, -10, 1, -10)
button.Position = UDim2.new(0, 5, 0, 5)
button.Text = "Ghost Mode: OFF"
button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.GothamBold
button.TextScaled = true
button.Parent = menuFrame

-- Tàng hình + thu nhỏ + vô hiệu hóa Humanoid
local function cloakCharacter()
	local char = player.Character
	if not char then return end
	for _, part in pairs(char:GetDescendants()) do
		if part:IsA("BasePart") then
			part.LocalTransparencyModifier = 1
			part.CanCollide = false
			part.CanTouch = false
			part.CanQuery = false
			part.Size = Vector3.new(0.1, 0.1, 0.1)
		elseif part:IsA("Decal") then
			part.Transparency = 1
		end
	end
	local hum = char:FindFirstChildOfClass("Humanoid")
	if hum then
		hum:SetStateEnabled(Enum.HumanoidStateType.Physics, false)
		hum:ChangeState(Enum.HumanoidStateType.None)
		hum.PlatformStand = true
	end
end

-- Khôi phục nhân vật
local function uncloakCharacter()
	local char = player.Character
	if not char then return end
	for _, part in pairs(char:GetDescendants()) do
		if part:IsA("BasePart") then
			part.LocalTransparencyModifier = 0
			part.CanCollide = true
			part.CanTouch = true
			part.CanQuery = true
			part.Size = Vector3.new(2, 2, 1) -- kích thước mặc định gần đúng
		elseif part:IsA("Decal") then
			part.Transparency = 0
		end
	end
	local hum = char:FindFirstChildOfClass("Humanoid")
	if hum then
		hum:SetStateEnabled(Enum.HumanoidStateType.Physics, true)
		hum:ChangeState(Enum.HumanoidStateType.Running)
		hum.PlatformStand = false
	end
end

-- Tạo clone đứng yên
local function createGhostClone()
	local char = player.Character
	if not char or not char.PrimaryPart then return end
	local clone = char:Clone()
	if not clone then return end
	clone.Name = player.Name .. "_GhostClone"
	for _, obj in pairs(clone:GetDescendants()) do
		if obj:IsA("Humanoid") or obj:IsA("Script") or obj:IsA("LocalScript") then obj:Destroy() end
	end
	local hrp = clone:FindFirstChild("HumanoidRootPart")
	if hrp then
		hrp.Anchored = true
		clone:SetPrimaryPartCFrame(char.PrimaryPart.CFrame)
	end
	clone.Parent = Workspace
	Debris:AddItem(clone, 10)
end

-- Tạo part vô hình để giấu nhân vật
local function createHideBox()
	local box = Instance.new("Part")
	box.Size = Vector3.new(10,10,10)
	box.Anchored = true
	box.CanCollide = false
	box.Transparency = 1
	box.Position = Vector3.new(0, -50, 0)
	box.Name = "GhostHideBox"
	box.Parent = Workspace
	Debris:AddItem(box, 10)
	return box
end

-- Kích hoạt ghost
local function activateGhostMode()
	local char = player.Character
	if not char or not char.PrimaryPart then return end
	originalCFrame = char.PrimaryPart.CFrame
	cloakCharacter()
	createGhostClone()
	local hideBox = createHideBox()
	char:SetPrimaryPartCFrame(hideBox.CFrame + Vector3.new(0,5,0))

	-- Tự động khôi phục sau 10 giây
	task.delay(10, function()
		if ghostOn then
			ghostOn = false
			button.Text = "Ghost Mode: OFF"
			uncloakCharacter()
			char:SetPrimaryPartCFrame(originalCFrame)
			local box = Workspace:FindFirstChild("GhostHideBox")
			if box then box:Destroy() end
		end
	end)
end

-- Tắt ghost thủ công
local function deactivateGhostMode()
	local char = player.Character
	if not char then return end
	uncloakCharacter()
	if originalCFrame then
		char:SetPrimaryPartCFrame(originalCFrame)
	end
	local box = Workspace:FindFirstChild("GhostHideBox")
	if box then box:Destroy() end
end

-- GUI sự kiện
button.MouseButton1Click:Connect(function()
	ghostOn = not ghostOn
	button.Text = ghostOn and "Ghost Mode: ON" or "Ghost Mode: OFF"
	if ghostOn then
		activateGhostMode()
	else
		deactivateGhostMode()
	end
end)

-- Tự động khôi phục khi respawn
player.CharacterAdded:Connect(function(c)
	char = c
	wait(2)
	if ghostOn then
		activateGhostMode()
	end
end)
