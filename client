local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local char, humanoid, hrp
local fakeBody = nil
local isActive = false

local DOWN_OFFSET = 2.5
local TELEPORT_KEY = Enum.KeyCode.T

-- Đảm bảo nhân vật đã spawn
local function waitForCharacter()
	char = player.Character or player.CharacterAdded:Wait()
	humanoid = char:WaitForChild("Humanoid")
	hrp = char:WaitForChild("HumanoidRootPart")
end

-- Tạo thân giả an toàn
local function createFakeBody()
	waitForCharacter()

	if fakeBody then
		fakeBody:Destroy()
	end

	local newModel = Instance.new("Model")
	newModel.Name = player.Name .. "_FakeBody"

	for _, part in ipairs(char:GetChildren()) do
		if part:IsA("BasePart") or part:IsA("Humanoid") then
			local clonePart = part:Clone()
			clonePart.Parent = newModel
		end
	end

	newModel.Parent = workspace

	local fakeHRP = newModel:FindFirstChild("HumanoidRootPart")
	if fakeHRP and hrp then
		fakeHRP.CFrame = hrp.CFrame
	end

	fakeBody = newModel
end

-- Dịch người thật xuống dưới
local function moveRealBodyDown()
	if not hrp then return end
	local newPos = hrp.Position - Vector3.new(0, DOWN_OFFSET, 0)
	hrp.CFrame = CFrame.new(newPos) * hrp.CFrame.Rotation
end

-- Animation nằm sấp
local function playRagdollPose()
	local anim = Instance.new("Animation")
	anim.AnimationId = "rbxassetid://282574440"
	local track = humanoid:LoadAnimation(anim)
	track:Play()
end

-- Theo fake body
local function followFakeBody()
	task.spawn(function()
		while isActive and fakeBody and fakeBody.Parent and hrp do
			local fakeHRP = fakeBody:FindFirstChild("HumanoidRootPart")
			if fakeHRP then
				local targetPos = fakeHRP.Position - Vector3.new(0, DOWN_OFFSET, 0)
				hrp.CFrame = CFrame.new(targetPos) * fakeHRP.CFrame.Rotation
			end
			RunService.RenderStepped:Wait()
		end
	end)
end

-- Tắt hiệu ứng
local function stopEffect()
	if fakeBody then
		fakeBody:Destroy()
		fakeBody = nil
	end

	if hrp then
		hrp.Anchored = false
	end

	isActive = false
end

-- Bật/Tắt teleport
local function onTeleport()
	waitForCharacter()

	if isActive then
		stopEffect()
	else
		createFakeBody()
		moveRealBodyDown()
		playRagdollPose()
		followFakeBody()
		isActive = true
	end
end

-- Nút mobile
local function createMobileButton()
	local gui = Instance.new("ScreenGui")
	gui.Name = "TeleportGui"
	gui.ResetOnSpawn = false
	gui.Parent = player:WaitForChild("PlayerGui")

	local btn = Instance.new("TextButton")
	btn.Text = "Teleport"
	btn.Size = UDim2.new(0, 130, 0, 50)
	btn.Position = UDim2.new(1, -140, 1, -80)
	btn.BackgroundColor3 = Color3.fromRGB(70, 70, 255)
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 22
	btn.Parent = gui

	btn.Activated:Connect(onTeleport)
end

-- Phím T trên PC
UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == TELEPORT_KEY then
		onTeleport()
	end
end)

createMobileButton()
